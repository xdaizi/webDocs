# 缓存和代理
## 一.缓存
### 1.服务端缓存控制：Cache-Control
- Expires：过期的时间点
- max-age： 缓存的时间长度，优先级高于Expires
- public：共享缓存，可以被所有的用户缓存，包括终端用户和CDN等中间代理服务器
- s-maxage： 共享缓存过期时间
- private：私有缓存，只能被用户的浏览器缓存
- no_store： 不使用缓存，每次都去服务端拉取最新的
	买来的西瓜不允许放进冰箱，要么立刻吃，要么立刻扔掉；
- no_cache： 每次先去服务器看是否有最新的，有则使用最新的，否则使用缓存
	可以放进冰箱，但吃之前必须问超市有没有更新鲜的，有就吃超市里的
- must-revalidate: 缓存不过期则继续使用，过期了则去服务端验证
	可以放进冰箱，保鲜期内可以吃，过期了就要问超市让不让吃
	![[Cache-Control.png]]
### 2.客户端缓存控制

#### 强缓存 Cache-Control：取值同服务端
其实不止服务器可以发“Cache-Control”头，浏览器也可以发“Cache-Control”，也就是说请求 - 应答的双方都可以用这个字段进行缓存控制，互相协商缓存的使用策略
生效 （200） 显示 from disk/memory cache，
#### 协商缓存
每次都会取服务器校验，一致取缓存（304），不一致则取服务器最新
- If-Modified-Since和Last-modified
	- If-Modified-Since：浏览器端拿服务器之前的修改时间去让服务端校验
	- Last-modified：服务器端回应的上次修改的时间
	- 两者比对，一致则取缓存，不一致则取服务器返回的数据
- If-None-Match 和 ETag
	- If-None-Match：浏览器拿服务器之前给的ETag让服务器校验
	- ETag：服务器返回当前的ETag
	- 两者比对，一致则取缓存，不一致则取服务器返回的数据
- 优先级：ETag > Last-modified
### 3.优先级
- 强缓存 > 协商缓存、
- 如果强缓存在有效期内，则强缓存生效，直接使用强缓存。
- 否则协商缓存生效，然后再去服务器验证，缓存有效则使用缓存，无效则使用服务器最新资源
### 4.浏览器动作对缓存的有效影响
- 刷新：强缓存失效，协商缓存有效
- F5强刷新：强缓存，协商缓存都失效

	![[浏览器操作对缓存的影响.jpg]]
### 5.memory cache和disk cache
**from memory cache**：资源是直接从内存中拿到的，**不会请求服务器**一般已经加载过该资源且缓存在了内存当中，当关闭该页面时，此资源就被内存释放掉了，再次重新打开相同页面时不会出现from memory cache的情况

**from disk cache**：资源是从磁盘当中取出的，也是在已经在之前的某个时间加载过该资源，**不会请求服务器**但是此资源不会随着该页面的关闭而释放掉，因为是存在硬盘当中的，下次打开仍会from disk cache

![[资源来源.png]]


由此可见样式表一般在磁盘中，不会缓存到内存中去，因为css样式加载一次即可渲染出网页
但是脚本却可能随时会执行，如果脚本在磁盘当中，在执行该脚本需要从磁盘中取到内存当中来
这样的IO开销是比较大的，有可能会导致浏览器失去响应
	
	

## 代理
### 1.代理的基本概念
客户端到服务器链路中间加入个中间服务器，
所以代理服务器既是上游服务器的客户端，也是下游客户端的服务器
### 2.作用
-	负载均衡：决定由后面的哪台服务器（较空闲）来响应请求
-	健康检查：通过心跳检测服务器集群的状况，把异常的服务器踢出，保证集群正常
-	安全防护：保护被代理的服务器，限制IP地址或者流量，抵御网络攻击或者过载
-	数据过滤：拦截上下行的数据，任意指定策略修改请求或者响应
-	加密卸载：对外机密传输，对内不加密，减少传输成本
-	内容缓存：暂存复用服务器i响应，比如CDN
### 3.代理相关头字段
字段可被代理服务器修改，不一定可靠
- Via: 标明代理服务器的身份
- X-Forwarded-For：为谁转发，添加请求方的IP（客户端 代理服务器）
- X-Real-IP：真实客户端的IP
### 4.代理的问题
- 延长了链路。增加了传输成本及相应时间
- 无法确认代理的安全性，可能被人攻击
### 5.代理缓存优化
优化一般来说都是时空转换，时间换空间，空间换时间
代理缓存属于空间换时间，更快的响应