# 流媒体协议
## 一.编码
### 1.为什么要编码
一般来说60fps就比较流畅了，也就是1s内60张图片。
假设图片是1024x768，每个像素点有RGB组成，所以每个像素点是8x3=24bite
一张图片就是 1024x768x24 .
1s内60张图：1024x768x24x60
1分钟60s：1024x768x24x60x60
1分钟差不多16G的大小。明显不能直接传输。所以需要进行编码（压缩）处理

### 2.编码
1. **空间冗余**：图片中相邻像素一般是有关联性的，渐变的，不会是突变的，所以不用每个像素点的数据都完整保留，可以隔几个保存一个，中间的用算法计算出来
2. **时间冗余**：视频序列的相邻图像之间内容相似。一个视频中连续出现的图片也不是突变的，可以根据已有的图片进行预测和推断
3.  **视觉冗余**：人的视觉系统对某些细节不敏感，因此不会每一个细节都注意到，可以允许丢失一些数据。
4.  **编码冗余**：不同像素值出现的概率不同，概率高的用的字节少，概率低的用的字节多


![[编码过程.png]]


## 二.直播的大体流程

### 1.直播的流程
![[直播流程.png]]
### 2.编码，图片转化为二进制流
- I帧：关键帧，里面是完整的图片，只需要本帧数据，就可以完成解码
- P帧：前向预测编码帧，P帧保留的是当前帧和前一帧（I帧，P帧）的差别。解码的时候需要前一帧的数据加上本帧的数据，生成最终画面
- B 帧：双向预测帧，B 帧记录的是本帧与前后帧的差别。要解码 B 帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的数据与本帧数据的叠加，取得最终的画面。

I 帧最完整，B 帧压缩率最高，而压缩后帧的序列，应该是在 IBBP 的间隔出现的。这就是**通过时序进行编码**。


![[帧的数据内容.png]]

每一帧都会分成多个片，每一片又会分成多个宏块，每个宏块又会分成多个子块，这样就将一张大图分解成一个个小块，可以方便的进行空间上的编码

### 3.推流
将二进制的流打包成网络包发送出去，例如：**RTMP 协议**

- RTMP协议是基于TCP协议的，在TCP连接的基础上要建立一个RTMP连接
- RTMP连接的作用：
	- 保证客户端和服务端的版本号一致
	- 时间戳：知道知道客户端，服务端的时间差
- 沟通这些事情，需要发送六条消息：客户端发送 C0、C1、 C2，服务器发送 S0、 S1、 S2。
	- 客户端发送 C0 表示自己的版本号，不必等对方的回复，然后发送 C1 表示自己的时间戳。
	- 服务器只有在收到 C0 的时候，才能返回 S0，表明自己的版本号，如果版本不匹配，可以断开连接。
	- 服务器发送完 S0 后，也不用等什么，就直接发送自己的时间戳 S1
	- 客户端收到 S1 的时候，发一个知道了对方时间戳的 ACK C2。同理服务器收到 C1 的时候，发一个知道了对方时间戳的 ACK S2。握手完成
- 握手之后要商量互相传递的控制信息，例如chunk和窗口的大小。真正传输数据的时候，还是需要创建一个流 Stream，然后通过这个 Stream 来推流 publish

### 4.接流
服务端拿到推流推过来的视频流，
### 5.分发
大量观看直播的观众就可以通过 RTMP 协议从流媒体服务器上拉取，但是这么多的用户量，都去同一个地方拉取，服务器压力会很大，而且用户分布在全国甚至全球，如果都去统一的一个地方下载，也会时延比较长，需要有分发网络

- 边缘层服务器部署在全国各地及横跨各大运营商里，和用户距离很近。为用户提供推 / 拉流服务
- 中心层是流媒体服务集群，负责内容的转发。智能负载均衡系统，根据用户的地理位置信息，就近选择边缘服务器，为用户提供推 / 拉流服务。中心层也负责转码服务例如，把 RTMP 协议的码流转换为 HLS 码流

### 6.拉流，解码，播放
先读到的是 H.264 的解码参数，例如 SPS 和 PPS，然后对收到的 NALU 组成的一个个帧，进行解码，交给播发器播放


## 三.H264
https://juejin.cn/post/6844903511386243079#heading-7
### 1.H264的压缩
- 帧内预测压缩：解决的是空域数据冗余问题。
- 帧间预测压缩：（运动估计与补偿），解决的是时域数据冗徐问题。
- 视觉冗余压缩：去除视觉系统不敏感的数据
- CABAC压缩：不同数据值出现的概率不同，给高频数据短码，给低频数据长码

### 2.帧的分类
- I帧：关键帧，里面是完整的图片，只需要本帧数据，就可以完成解码
- P帧：前向预测编码帧，P帧保留的是当前帧和前一帧（I帧，P帧）的差别。解码的时候需要前一帧的数据加上本帧的数据，生成最终画面
- B 帧：双向预测帧，B 帧记录的是本帧与前后帧的差别。要解码 B 帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的数据与本帧数据的叠加，取得最终的画面。
-  图像序列GOP:两个I帧之间是一个图像序列，在一个图像序列中只有一个I帧

### 3.具体的压缩方式
- 帧分组（IBBP）：在相邻几幅图像画面中，一般有差别的像素只有10%以内的点,亮度差值变化不超过2%，而色度差值的变化只有1%以内，我们认为这样的图可以分到一组
- 划分宏块，子块：可以方便的进行空间上的编码。更好进行帧内压缩
- 帧间预测：帧之间的差异，如运动物体的变化。我们把运动矢量与补偿称为**帧间压缩技术**
- 帧内预测：人眼对图象都有一个识别度，对低频的亮度很敏感，对高频的亮度不太敏感。所以基于一些研究，可以将一幅图像中人眼不敏感的数据去除掉。这样就提出了帧内预测技术。图片上的像素点是关联的，所以隔几个保留一个像素的数据就好

- 去除视觉冗余：去除视觉系统不敏感的数据
- CABAC压缩：不同数据值出现的概率不同，给高频数据短码，给低频数据长码